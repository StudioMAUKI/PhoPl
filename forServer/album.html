<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="format-detection" content="telephone=no">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width">
    <title></title>


    <!-- compiled css output -->
    <link href="css/ionic.app.min.css" rel="stylesheet">
    
    <!-- ionic/angularjs js -->
    <script src="lib/jquery/dist/jquery.min.js"></script>
    <script src="lib/ionic/js/ionic.bundle.js"></script>
  </head>


  <!--단순로직 -->
  <script>
      angular.module('phopl', ['ionic'])
      .run(function($ionicPlatform, $window, $state, $ionicHistory, $rootScope) {
        console.log("run()");
      })

      .factory('DOMHelper', [function() {
        function getImageHeight(elem, cols, padding) {
          cols = cols || 3;
          padding = (padding === null) ? 5 : padding;

          if (!elem) {
            return 0;
          }

          var elems = document.getElementsByClassName(elem);
          console.log('elems[' + elem + '].length : ' + elems.length);
          for (var i = 0; i < elems.length; i++) {
            console.log('elems[' + elem + '].clientWidth : ' + elems[i].clientWidth);
            if (elems[i].clientWidth) {
              return parseInt((elems[i].clientWidth - (cols + 1) * padding) / cols);
            }
          }
          return 0;
        }

        return {
          getImageHeight: getImageHeight
        }
      }])

      .controller('albumCtrl', function($scope, $q, $ionicPlatform, $ionicPopup, $ionicModal, $ionicSlideBoxDelegate, $ionicScrollDelegate, $ionicPopover, $ionicHistory, DOMHelper) {
        console.log("albumCtrl()");

        //서버에서 넣어주시면 됩니다. 
        
        //프로필 정보 
        $scope.uplace_uuid = '121212'; //UUID 
        $scope.uplace_name = "장소이름";
        $scope.profileImg = 'http://image.chosun.com/sitedata/image/201312/13/2013121302159_0.jpg';
        $scope.nickname = '홍길동';

        //포스트
        $scope.post = {
          datetime:'12123'
        }

        //노트 
        $scope.notes = [
          { content:'asfasdf', datetime:'asdfasdf'},
          { content:'asfasdf', datetime:'asdfasdf'},
        ]

        //이미지 
        $scope.attachedImages = [
          {summary: 'http://image.chosun.com/sitedata/image/201312/13/2013121302159_0.jpg',
           content: 'http://image.chosun.com/sitedata/image/201312/13/2013121302159_0.jpg'},
          {summary: 'http://cfile227.uf.daum.net/image/192ABF3350BC88EB224FF9',
          content: 'http://cfile227.uf.daum.net/image/192ABF3350BC88EB224FF9'},
          {summary:'http://pds25.egloos.com/pds/201207/23/96/e0063996_500c1d8f0a41d.jpg',
          content: 'http://pds25.egloos.com/pds/201207/23/96/e0063996_500c1d8f0a41d.jpg'},
          {summary: 'http://cfile28.uf.tistory.com/image/240FD148543CB20803D582',
          content: 'http://cfile28.uf.tistory.com/image/240FD148543CB20803D582' },
          {summary: 'http://cfile2.uf.tistory.com/image/2551564D54CC3B5128C971',
          content: 'http://cfile2.uf.tistory.com/image/2551564D54CC3B5128C971'}, 
          {summary: 'http://image.chosun.com/sitedata/image/201312/13/2013121302159_0.jpg',
           content: 'http://image.chosun.com/sitedata/image/201312/13/2013121302159_0.jpg'},
          {summary: 'http://cfile227.uf.daum.net/image/192ABF3350BC88EB224FF9',
          content: 'http://cfile227.uf.daum.net/image/192ABF3350BC88EB224FF9'},
          {summary:'http://pds25.egloos.com/pds/201207/23/96/e0063996_500c1d8f0a41d.jpg',
          content: 'http://pds25.egloos.com/pds/201207/23/96/e0063996_500c1d8f0a41d.jpg'},
          {summary: 'http://cfile28.uf.tistory.com/image/240FD148543CB20803D582',
          content: 'http://cfile28.uf.tistory.com/image/240FD148543CB20803D582' },
          {summary: 'http://cfile2.uf.tistory.com/image/2551564D54CC3B5128C971',
          content: 'http://cfile2.uf.tistory.com/image/2551564D54CC3B5128C971'}, 
          {summary: 'http://image.chosun.com/sitedata/image/201312/13/2013121302159_0.jpg',
           content: 'http://image.chosun.com/sitedata/image/201312/13/2013121302159_0.jpg'},
          {summary: 'http://cfile227.uf.daum.net/image/192ABF3350BC88EB224FF9',
          content: 'http://cfile227.uf.daum.net/image/192ABF3350BC88EB224FF9'},
          {summary:'http://pds25.egloos.com/pds/201207/23/96/e0063996_500c1d8f0a41d.jpg',
          content: 'http://pds25.egloos.com/pds/201207/23/96/e0063996_500c1d8f0a41d.jpg'},
          {summary: 'http://cfile28.uf.tistory.com/image/240FD148543CB20803D582',
          content: 'http://cfile28.uf.tistory.com/image/240FD148543CB20803D582' },
          {summary: 'http://cfile2.uf.tistory.com/image/2551564D54CC3B5128C971',
          content: 'http://cfile2.uf.tistory.com/image/2551564D54CC3B5128C971'}, 
        ];

        //관련정보
        $scope.searchResults = [
          {title:'치킨엔맥쥬', author:'치맥', description:'치킨은진리', link:'http://naver.com'},
          {title:'한방통닭', author:'통닭', description:'통닭은반반', link:'http://www.daum.net'}
        ]
        //서버에서 넣어주시면 됩니다. @
  
       var result = this; 
      
      $scope.showAll = false;
      $scope.zoomMin = 1;
      $scope.calculatedHeight = DOMHelper.getImageHeight('view-container', 3, 5);
 
      //////////////////////////////////////////////////////////////////////////////
      //  Event Handler
      //////////////////////////////////////////////////////////////////////////////
      $scope.$on('$ionicView.afterEnter', function() {
        $scope.post = PKSessionStorage.get('albumToShow');
        if ($scope.post.userPost.notes) {
          for (var i = 0; i < $scope.post.userPost.notes.length; i++) {
            $scope.post.userPost.notes[i].datetime = PostHelper.getTimeString($scope.post.userPost.notes[i].timestamp);
          }
        }

        console.debug('post', $scope.post);
        if ($scope.post.userPost.ru.data) {
          $scope.profileImg = $scope.post.userPost.ru.data.profileImg || 'img/blank-profile.png';
        } else {
          $scope.profileImg = 'img/blank-profile.png';
        }
        getDaumResult();
        if (RemoteAPIService.isTakenPlace($scope.post.uplace_uuid)) {
          $scope.canTakeToMyList = false;
        } else {
          $scope.canTakeToMyList = true;
        }
      });

      //////////////////////////////////////////////////////////////////////////////
      //  Public Methods
      //////////////////////////////////////////////////////////////////////////////
      $scope.showMap = function() {
        $ionicModal.fromTemplateUrl('list/modal.map.html', {
          scope: $scope
        })
        .then(function(modal) {
          $scope.modalMap = modal;
          $scope.modalMap.show();
          fitMapToScreen();
          initMap({
            lat: $scope.post.lonLat.lat,
            lng: $scope.post.lonLat.lon
          });
        });
      }
      $scope.closeMap = function() {
        $scope.modalMap.hide();
        $scope.modalMap.remove();
        $scope.map = null;
      }

      $scope.share = function() {
        getShortenURLAndCopyToClipboard();
      }

      $scope.openLink = function(url) {
        console.info('url: ' + url);
        window.open(url, '_system'); //외부 browser 
      };
      
      $scope.showAllImages = function() {
        $scope.showAll = true;
        $ionicScrollDelegate.resize();
        // $scope.$apply();
      }

      $scope.showImagesWithFullScreen = function(index) {
        $scope.activeSlide = index;
        $ionicModal.fromTemplateUrl('modal.images.html', {
          scope: $scope
        }).then(function(modal) {
          $scope.modalImages = modal;
          $scope.modalImages.show();
        });
      }

      $scope.closeImages = function() {
        $scope.modalImages.hide();
        $scope.modalImages.remove();
      };

      $scope.updateSlideStatus = function(slide) {
        var zoomFactor = $ionicScrollDelegate.$getByHandle('scrollHandle' + slide).getScrollPosition().zoom;
        if (zoomFactor == $scope.zoomMin) {
          $ionicSlideBoxDelegate.enableSlide(true);
        } else {
          $ionicSlideBoxDelegate.enableSlide(false);
        }
      };

      $scope.popOverMore = function(event) {
        console.info('popOverMore() called');
        $ionicPopover.fromTemplateUrl('list/popover.edit.html', {
          scope: $scope
        })
        .then(function(popover){
          $scope.popOver = popover;
          $scope.popOver.show(event);
          console.info('popOverShow()');
        });
      };

      $scope.edit = function() {
        console.info('edit() called');
      };

      $scope.delete = function() {
        console.info('delete() called');
        $scope.popOver.hide();
        $scope.popOver.remove();
        $ionicPopup.confirm({
          title: '삭제',
          template: '앨범을 삭제 하시겠습니까?'
        })
        .then(function(res){
          if (res) {
            RemoteAPIService.deleteUserPost($scope.post.uplace_uuid)
            .then(function() {
              $ionicPopup.alert({
                title: '성공',
                template: '삭제되었습니다'
              })
              .then(function() {
                $ionicHistory.goBack();
              });
            }, function(err) {
              console.error(err);
            });
          }
        });
      };

      $scope.take = function() {
        RemoteAPIService.takeIplace($scope.post.uplace_uuid)
        .then(function(result) {
          console.log('album.take()', result);
        }, function(err) {
          console.error(err);
        });
      }


      }); 
      
  </script>
  <!--단순로직 @-->


  <body ng-app="phopl" ng-controller="albumCtrl" class="view-container"> 
 
       
      <!--앨범영역-->
      <ion-view view-title="{{post.name || '앨범'}}">
        <ion-content>
          <div class="list">
            <div class="item item-avatar item-button-right" href="#">
              <img ng-src="{{profileImg}}">
              <h2><strong>{{nickname}}</strong></h2>
              <small>{{post.datetime}}</small>
              <!--<a class="button button-outline button-stable icon ion-ios-more" style="top:15px;" ng-click="popOverMore($event)">-->
              </a>
            </div>
          </div>
          <!-- 노트 영역 -->
          <div class="note " ng-repeat="note in post.userPost.notes">
                <div class="padding">
                <span class="content">{{note.content}}</span>
                <!--<span class="time">{{note.datetime}}</span>-->
                </div> 
          </div>
          <!-- 이미지 영역 -->
          <div ng-repeat="image in attachedImages track by $index" style="width:{{calculatedHeight+5}}px;height:{{calculatedHeight}}px;display:inline-block;overflow:hidden;padding-left:5px;" ng-show="attachedImages.length > 2 && (showAll || (!showAll && $index < 9))">
            <img style="height:{{calculatedHeight}}px;" ng-src="{{image.summary}}" ng-click="showImagesWithFullScreen($index)" on-hold="deleteAttatchedImage($index)">
            <div style="width:{{calculatedHeight+6}}px;height:{{calculatedHeight+1}}px;position:relative;text-align:center;top:-{{calculatedHeight+6}}px;z-index:100;background-color:rgba(0,0,0,0.5);padding-top:30px;" ng-show="$index === 8 && attachedImages.length > 9 && showAll === false" ng-click="showAllImages()"><h1 style="color:white;padding-top:8px;">+{{attachedImages.length - 9}}</h1></div>
          </div>

          <div ng-repeat="image in attachedImages track by $index"  ng-show="attachedImages.length < 3">
            <img style="width:100%" ng-src="{{image.summary}}" ng-click="showImagesWithFullScreen($index)" on-hold="deleteAttatchedImage($index)">
          </div>

          <!-- 장소 정보 출력 영역 -->
          <div class="row" ng-show="post.name">
            <div class="col border" ng-click="showMap()">
              <strong ><i class="ion-ios-location"></i>{{post.name}}</strong><br>
              <small>{{post.addrs[0]}}</small><br>
              <!-- <small>동네술집, 맥주한잔, 와인저렴, 콜키지무료, 이탈리안, 퓨전, 개성</small> -->
              <small ng-repeat="tag in post.userPost.tags">#{{tag.content}},&nbsp;</small>
            </div>
          </div>

          <!-- 검색 결과 -->
          <div class="list">
            <div class="item item-divider" ng-show="searchResults.length > 0">
              관련 정보
            </div>
            <div class="item item-divider" ng-show="searchResults.length == 0">
              관련 정보 없음
            </div>
            <a ng-repeat="result in searchResults | limitTo: 5 track by $index" class="item" ng-click="openLink(result.link)">
              <h2>{{result.title}}</h2>
              <h3>{{result.author}}</h3>
              <p>{{result.description}}</p>
            </a>
            <!-- 블로그 더 보기 버튼 -->
            <!-- <a class="item" href="#" style="text-align: center;" ng-show="place.post.name" ng-click="place.searchPlace()">
              관련 블로그 더보기
            </a> -->
          </div>
 
        </ion-content>

        <!-- 하단 버튼 바 -->
        <ion-footer-bar>
          <div class="button-bar" style="margin-top:5px;">
            <a class="button button-stable" ng-click="showMap()" ng-show="post.lonLat">지도</a>
            <a class="button button-stable" ng-click="take()" ng-show="canTakeToMyList">저장</a>
            <a class="button button-stable" ng-click="share()">공유</a>
          </div>
        </ion-footer-bar>
      </ion-view>
      <!--앨범영역@-->
 
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDkuFga8fr1c4PjzSAiHaBWo26zvQbtxB8&libraries=places"></script>
    <script type="text/javascript" src="http://apis.daum.net/maps/maps3.js?apikey=f4e2c3f6c532baf54ec80e81f08fc1a1&amp;libraries=services"></script>
  </body>
</html>

